name: å¤šå¹³å°æž„å»º

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: æž„å»ºWindowsç‰ˆæœ¬
      run: python build-ci.py
    
    - name: ä¸Šä¼ Windowsæž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: file-save-system-windows
        path: dist/
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: æž„å»ºmacOSç‰ˆæœ¬
      run: python build-ci.py
    
    - name: ä¸Šä¼ macOSæž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: file-save-system-macos
        path: dist/
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: æž„å»ºLinuxç‰ˆæœ¬
      run: python build-ci.py
    
    - name: ä¸Šä¼ Linuxæž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: file-save-system-linux
        path: dist/
        retention-days: 30

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        path: artifacts/
    
    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        
        # å¤åˆ¶Windowsç‰ˆæœ¬
        if [ -d "artifacts/file-save-system-windows" ]; then
          cp -r artifacts/file-save-system-windows/* release/
        fi
        
        # å¤åˆ¶macOSç‰ˆæœ¬
        if [ -d "artifacts/file-save-system-macos" ]; then
          cp -r artifacts/file-save-system-macos/* release/
        fi
        
        # å¤åˆ¶Linuxç‰ˆæœ¬
        if [ -d "artifacts/file-save-system-linux" ]; then
          cp -r artifacts/file-save-system-linux/* release/
        fi
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > release/start_windows.bat << 'EOF'
        @echo off
        echo å¯åŠ¨æ–‡ä»¶ä¿å­˜ç³»ç»Ÿ...
        echo è®¿é—®åœ°å€: http://localhost:8000
        echo æŒ‰Ctrl+Cåœæ­¢æœåŠ¡
        echo.
        file_save_system.exe runserver 0.0.0.0:8000
        pause
        EOF
        
        cat > release/start_macos.sh << 'EOF'
        #!/bin/bash
        echo "å¯åŠ¨æ–‡ä»¶ä¿å­˜ç³»ç»Ÿ..."
        echo "è®¿é—®åœ°å€: http://localhost:8000"
        echo "æŒ‰Ctrl+Cåœæ­¢æœåŠ¡"
        echo ""
        ./file_save_system runserver 0.0.0.0:8000
        EOF
        
        cat > release/start_linux.sh << 'EOF'
        #!/bin/bash
        echo "å¯åŠ¨æ–‡ä»¶ä¿å­˜ç³»ç»Ÿ..."
        echo "è®¿é—®åœ°å€: http://localhost:8000"
        echo "æŒ‰Ctrl+Cåœæ­¢æœåŠ¡"
        echo ""
        ./file_save_system runserver 0.0.0.0:8000
        EOF
        
        chmod +x release/start_macos.sh
        chmod +x release/start_linux.sh
        
        # åˆ›å»ºREADME
        cat > release/README.md << 'EOF'
        # æ–‡ä»¶ä¿å­˜ç³»ç»Ÿ - å¤šå¹³å°ç‰ˆæœ¬
        
        ## ä½¿ç”¨æ–¹æ³•
        
        ### Windows
        1. åŒå‡» `start_windows.bat` å¯åŠ¨æœåŠ¡
        2. æˆ–ç›´æŽ¥è¿è¡Œ `file_save_system.exe`
        
        ### macOS
        1. è¿è¡Œ `./start_macos.sh` å¯åŠ¨æœåŠ¡
        2. æˆ–ç›´æŽ¥è¿è¡Œ `./file_save_system`
        
        ### Linux
        1. è¿è¡Œ `./start_linux.sh` å¯åŠ¨æœåŠ¡
        2. æˆ–ç›´æŽ¥è¿è¡Œ `./file_save_system`
        
        ## è®¿é—®åœ°å€
        - ä¸»é¡µé¢: http://localhost:8000
        - APIæ–‡æ¡£: http://localhost:8000/swagger/
        - ç®¡ç†åŽå°: http://localhost:8000/admin/
        
        ## æ³¨æ„äº‹é¡¹
        - é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®åº“
        - é»˜è®¤ç®¡ç†å‘˜è´¦å·: admin / admin123
        - æŒ‰Ctrl+Cåœæ­¢æœåŠ¡
        EOF
    
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        body: |
          ## æ–‡ä»¶ä¿å­˜ç³»ç»Ÿ v${{ github.event.release.tag_name }}
          
          ### åŒ…å«å¹³å°
          - âœ… Windows (.exe)
          - âœ… macOS (å¯æ‰§è¡Œæ–‡ä»¶)
          - âœ… Linux (å¯æ‰§è¡Œæ–‡ä»¶)
          
          ### ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…
          2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œå¯åŠ¨è„šæœ¬æˆ–å¯æ‰§è¡Œæ–‡ä»¶
          4. è®¿é—® http://localhost:8000
          
          ### åŠŸèƒ½ç‰¹æ€§
          - ðŸ“ æ–‡ä»¶ä¸Šä¼ å’Œç®¡ç†
          - ðŸ” æ™ºèƒ½æœç´¢å’Œåˆ†ç±»
          - ðŸ“Š æ€§èƒ½ç›‘æŽ§
          - ðŸ” ç”¨æˆ·æƒé™ç®¡ç†
          - ðŸ“ æ“ä½œåŽ†å²è®°å½•
          
          ### ç³»ç»Ÿè¦æ±‚
          - Windows 10/11 æˆ– macOS 10.15+ æˆ– Linux
          - è‡³å°‘ 2GB å†…å­˜
          - è‡³å°‘ 100MB ç£ç›˜ç©ºé—´
        draft: false
        prerelease: false